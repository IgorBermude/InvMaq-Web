{% extends "base.html" %}
{% block content %}
{% if maquina_filter %}
  <h2>Hist√≥rico da M√°quina
    {% for mm in maquinas %}
      {% if mm.id == maquina_filter %} - {{ mm.nome }}{% endif %}
    {% endfor %}
  </h2>

  <div class="mb-3">
    <a href="/" class="btn btn-secondary">‚Üê Voltar</a>
  </div>

  <form id="addHistoricoForm" action="/historico/add" method="post" class="mb-4" enctype="multipart/form-data">
    <input type="hidden" name="id_maquina" value="{{ maquina_filter }}">
    <div class="row g-2 mb-4">
      <div class="col">
        <label class="form-label">Data</label>
        <input name="data" type="date" class="form-control" required>
      </div>
      <div class="col">
        <label class="form-label">Hora</label>
        <input name="hora" type="time" class="form-control" required>
      </div>
      <div class="col">
        <label class="form-label">Respons√°vel</label>
        <input name="tecnico" class="form-control" placeholder="Responsavel">
      </div>
    </div>
    <div class="col mb-4">
      <label class="form-label">Descri√ß√£o</label>
      <textarea name="descricao" class="form-control" placeholder="Descri√ß√£o" required rows="4"></textarea>
    </div>
    <div class="col-auto mt-2 d-flex align-items-start gap-3 flex-wrap">
      <button class="btn btn-primary" id="btnSubmitHistorico">Adicionar</button>
      <button type="button" class="btn btn-success" id="btnSelectFile">Adicionar Arquivo</button>
      <input type="file" name="arquivo" id="arquivoInput" accept="image/*,.pdf" class="d-none">
    </div>
    <div id="arquivoPreview" class="mt-3"></div>
  </form>

  <script>
  // Enviar o formul√°rio via fetch e redirecionar ao concluir para manter o filtro da m√°quina
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('addHistoricoForm');
    if (form) {
      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const url = form.action;
        const formData = new FormData(form);
        try {
          const resp = await fetch(url, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
          });
          if (resp.ok) {
            // redireciona para a p√°gina de hist√≥rico com o filtro da m√°quina
            window.location.href = '/historico?maquina={{ maquina_filter }}';
          } else {
            const text = await resp.text();
            alert('Falha ao adicionar hist√≥rico.' + (text ? '\\n' + text : ''));
          }
        } catch (err) {
          alert('Erro de rede ao adicionar hist√≥rico.');
        }
      });
    }

    // Intercepta cliques nos links de excluir e faz a requisi√ß√£o via fetch,
    // depois redireciona para manter o filtro da m√°quina.
    document.addEventListener('click', async function (ev) {
      const el = ev.target.closest('a.delete-historico');
      if (!el) return;
      ev.preventDefault();
      const msg = el.dataset.confirm || 'Tem certeza que deseja excluir este item do hist√≥rico?';
      if (!confirm(msg)) return;
      try {
        const resp = await fetch(el.href, {
          method: 'GET',
          credentials: 'same-origin'
        });
        if (resp.ok) {
          window.location.href = '/historico?maquina={{ maquina_filter }}';
        } else {
          const text = await resp.text();
          alert('Falha ao excluir.' + (text ? '\\n' + text : ''));
        }
      } catch (err) {
        alert('Erro de rede ao excluir.');
      }
    });

    const btnSelectFile = document.getElementById('btnSelectFile');
    const inputFile = document.getElementById('arquivoInput');
    const preview = document.getElementById('arquivoPreview');

    if (btnSelectFile && inputFile) {
      btnSelectFile.addEventListener('click', () => inputFile.click());
      inputFile.addEventListener('change', () => {
        preview.innerHTML = '';
        const f = inputFile.files && inputFile.files[0];
        if (!f) return;
        const wrap = document.createElement('div');
        wrap.className = 'border rounded p-3 bg-light w-100';
        const title = document.createElement('div');
        title.className = 'fw-semibold mb-2';
        title.textContent = 'Arquivo selecionado: ' + f.name + ' (' + Math.round(f.size/1024) + ' KB)';
        wrap.appendChild(title);

        if (f.type.startsWith('image/')) {
          const img = document.createElement('img');
            img.style.maxWidth = '220px';
            img.style.maxHeight = '220px';
            img.style.objectFit = 'cover';
            img.alt = f.name;
            img.src = URL.createObjectURL(f);
            wrap.appendChild(img);
        } else if (f.type === 'application/pdf') {
          const pdfInfo = document.createElement('div');
          pdfInfo.innerHTML = 'PDF selecionado. <span class="text-muted">Ser√° enviado ao salvar.</span>';
          const embed = document.createElement('embed');
          embed.type = 'application/pdf';
          embed.style.width = '300px';
          embed.style.height = '320px';
          embed.src = URL.createObjectURL(f);
          wrap.appendChild(pdfInfo);
          wrap.appendChild(embed);
        } else {
          const generic = document.createElement('div');
          generic.textContent = 'Tipo de arquivo: ' + (f.type || 'desconhecido');
          wrap.appendChild(generic);
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-sm btn-outline-danger mt-3 me-3';
        removeBtn.textContent = 'Remover arquivo';
        removeBtn.addEventListener('click', () => {
          inputFile.value = '';
          preview.innerHTML = '';
        });
        wrap.appendChild(removeBtn);

        preview.appendChild(wrap);
      });
    }
  });
  </script>

  <a href="/report/historico?maquina={{ maquina_filter }}" class="btn btn-success mb-3">üìÑ Exportar PDF</a>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Data</th>
        <th>Hora</th>
        <th>Responsavel</th>
        <th>Descri√ß√£o</th>
        <th>IP</th>
        <th>MAC</th>
        <th>Arquivo</th>
        <th colspan="2">A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {% for h in historico %}
      <tr>
        <td>{{h.data}}</td>
        <td>{{h.hora}}</td>
        <td>{{h.tecnico}}</td>
        <td>{{h.descricao}}</td>
        {% for m in maquinas %}
          {% if m.id == h.id_maquina %}
            <td>{{ m.ip }}</td>
            <td>{{ m.mac }}</td>
          {% endif %}
        {% endfor %}
        <td>
          {% set tem_foto = h.foto if h.foto is defined else (h['foto'] if 'foto' in h else None) %}
          {% if tem_foto %}
            <a href="/historico/foto/{{h.id}}" target="_blank" class="btn btn-sm btn-info">Ver Arquivo</a>
          {% else %}
            <span class="text-muted">N/A</span>
          {% endif %}
        </td>
        <td><a href="/historico/edit/{{h.id}}" class="btn btn-sm btn-warning">Editar</a></td>
        <td><a href="/historico/delete/{{h.id}}" class="btn btn-sm btn-danger delete-historico" data-confirm="Tem certeza que deseja excluir este item do hist√≥rico?">Excluir</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <div class="alert alert-info">Esta p√°gina deve ser acessada a partir da lista de m√°quinas. Clique em "Hist√≥rico" na linha da m√°quina desejada.</div>
  <a href="/" class="btn btn-secondary">Voltar</a>
{% endif %}
{% endblock %}